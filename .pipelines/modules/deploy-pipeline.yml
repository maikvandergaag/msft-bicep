trigger: none

variables:
- group: 'deployment-variables'

stages:
  - stage: Deploy_IaC_Registry
    displayName: Deploy Certified Function
    jobs:
      - deployment: Deployment_Modules
        displayName: Deploy Azure Certified Function
        environment: "Azure Function"
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  clean: true
                - task: AzureCLI@2
                  displayName: 'Build Bicep file'
                  inputs:
                    azureSubscription: '$(serviceconnection-sub)'
                    scriptType: 'pscore'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az bicep build --file 'templatespecs/certifiedfunction/certifiedfunction.bicep'
                      az bicep build-params --file 'templatespecs/certifiedfunction/certifiedfunction-param.bicepparam'
                - task: AzureResourceManagerTemplateDeployment@3
                  displayName: 'Infrastructure - Deploy'
                  inputs:
                    deploymentScope: 'Resource Group'
                    azureResourceManagerConnection: '$(serviceconnection-sub)'
                    subscriptionId: '$(subscriptionId)'
                    resourceGroupName: 'sponsor-rg-testing'
                    location: 'West Europe'
                    templateLocation: 'templatespecs/certifiedfunction/certifiedfunction.bicep'
                    csmFile: 'templatespecs/certifiedfunction/certifiedfunction.bicep'
                    csmParametersFile: 'templatespec/certifiedfunction/certifiedfunction-param.json'
                    deploymentMode: 'Incremental'